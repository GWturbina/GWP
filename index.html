// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// GlobalWay DApp - Matrix Module
// üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –ß–∏—Ç–∞–µ—Ç –º–∞—Ç—Ä–∏—Ü—É –ù–ê–ü–†–Ø–ú–£–Æ –∏–∑ GlobalWay
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

const matrixModule = {
  contracts: {},
  
  state: {
    currentDepth: 1,
    currentRoot: null,
    matrixData: [],
    stats: {
      totalActive: 0,
      fromPartners: 0,
      fromCharity: 0,
      fromTechnical: 0
    }
  },

  async init() {
    console.log('üî≤ Initializing Matrix Module...');
    
    try {
      if (!app.state.userAddress) {
        app.showNotification('–ü–æ–¥–∫–ª—é—á–∏—Ç–µ –∫–æ—à–µ–ª–µ–∫', 'error');
        return;
      }

      this.state.currentRoot = app.state.userAddress;
      await this.loadContracts();
      this.createDepthButtons();
      await this.loadAllData();
      this.initUI();

      console.log('‚úÖ Matrix Module loaded successfully');
    } catch (error) {
      console.error('‚ùå Matrix init error:', error);
      app.showNotification('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –º–∞—Ç—Ä–∏—Ü—ã', 'error');
    }
  },

  async loadContracts() {
    this.contracts.globalWay = await app.getContract('GlobalWay');
    this.contracts.helper = await app.getContract('GlobalWayHelper');
    this.contracts.stats = await app.getContract('GlobalWayStats');
    this.contracts.quarterly = await app.getContract('GlobalWayQuarterly');
  },

  async loadAllData() {
    await Promise.all([
      this.loadMatrixVisualization(),
      this.loadMatrixTable(),
      this.loadMatrixStats()
    ]);
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –ß–∏—Ç–∞–µ–º –º–∞—Ç—Ä–∏—Ü—É –ù–ê–ü–†–Ø–ú–£–Æ –∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async loadMatrixVisualization() {
    try {
      const address = app.state.userAddress;
      const isRegistered = await this.contracts.globalWay.isUserRegistered(address);
      
      if (!isRegistered) {
        console.log("User not registered");
        return;
      }

      const { currentRoot } = this.state;

      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userPosition = await this.contracts.globalWay.getUserMatrixPosition(currentRoot);
      
      console.log(`üìç User matrix position:`, userPosition.toString());
      
      if (userPosition.toString() === "0") {
        console.log("‚ö†Ô∏è User not in matrix");
        return;
      }

      // üî• –ß–ò–¢–ê–ï–ú –ù–ê–ü–†–Ø–ú–£–Æ: 7 –ø–æ–∑–∏—Ü–∏–π (1 –∫–æ—Ä–µ–Ω—å + 2 —É—Ä–æ–≤–Ω—è)
      const rootPos = parseInt(userPosition.toString());
      const nodes = await this.readMatrixDirect(rootPos, 2);

      console.log(`‚úÖ Loaded ${nodes.length} nodes directly`);

      await this.updateVisualization(nodes);

    } catch (error) {
      console.error('‚ùå Error loading matrix:', error);
    }
  },

  async readMatrixDirect(rootPos, depth) {
  const nodes = [];
  
  // –ü–æ–∑–∏—Ü–∏—è 0: –∫–æ—Ä–µ–Ω—å
  nodes.push(await this.getNodeAtPosition(rootPos));
  
  // üî• –û–ë–™–Ø–í–õ–Ø–ï–ú –ó–î–ï–°–¨ - –î–û –í–°–ï–• IF!
  const leftChild = rootPos * 2;
  const rightChild = rootPos * 2 + 1;
  
  if (depth >= 1) {
    // –ü–æ–∑–∏—Ü–∏–∏ 1-2: –ø–µ—Ä–≤—ã–π —É—Ä–æ–≤–µ–Ω—å
    nodes.push(await this.getNodeAtPosition(leftChild));
    nodes.push(await this.getNodeAtPosition(rightChild));
  }
  
  if (depth >= 2) {
    // –ü–æ–∑–∏—Ü–∏–∏ 3-6: –≤—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å
    const positions = [
      leftChild * 2,
      leftChild * 2 + 1,
      rightChild * 2,
      rightChild * 2 + 1
    ];
    
    for (const pos of positions) {
      nodes.push(await this.getNodeAtPosition(pos));
    }
  }
  
  return nodes;
}

  // –ü–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ —É–∑–ª–∞ –Ω–∞ –ø–æ–∑–∏—Ü–∏–∏
  async getNodeAtPosition(position) {
    try {
      const [userAddress] = await this.contracts.globalWay.getMatrixPosition(position);
      
      if (userAddress === ethers.constants.AddressZero || 
          userAddress === '0x0000000000000000000000000000000000000000') {
        return {
          user: ethers.constants.AddressZero,
          position: position,
          userID: '',
          maxLevel: 0,
          isActive: false
        };
      }
      
      const userID = await this.contracts.helper.getUserID(userAddress);
      const maxLevel = await this.contracts.globalWay.getUserMaxLevel(userAddress);
      
      return {
        user: userAddress,
        position: position,
        userID: userID,
        maxLevel: maxLevel.toString(),
        isActive: maxLevel > 0
      };
      
    } catch (error) {
      console.error(`Error reading position ${position}:`, error);
      return {
        user: ethers.constants.AddressZero,
        position: position,
        userID: '',
        maxLevel: 0,
        isActive: false
      };
    }
  },

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –¥–µ—Ä–µ–≤–∞
  async updateVisualization(nodes) {
    try {
      // nodes[0] = –∫–æ—Ä–µ–Ω—å (topPosition)
      // nodes[1-2] = –ø–µ—Ä–≤—ã–π —É—Ä–æ–≤–µ–Ω—å (position1, position2)
      // nodes[3-6] = –≤—Ç–æ—Ä–æ–π —É—Ä–æ–≤–µ–Ω—å (position3-6)

      const positionIds = [
        'topPosition',  // 0
        'position1',    // 1
        'position2',    // 2
        'position3',    // 3
        'position4',    // 4
        'position5',    // 5
        'position6'     // 6
      ];

      for (let i = 0; i < positionIds.length && i < nodes.length; i++) {
        await this.updatePosition(positionIds[i], nodes[i]);
      }

    } catch (error) {
      console.error('Error updating visualization:', error);
    }
  },

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ–¥–Ω–æ–π –ø–æ–∑–∏—Ü–∏–∏ –≤ –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏
  async updatePosition(elementId, nodeData) {
    const element = document.getElementById(elementId);
    if (!element) return;

    const userAddress = nodeData.user;

    if (userAddress === ethers.ZeroAddress) {
      // –ü—É—Å—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è
      element.querySelector('.position-id').textContent = 'Empty';
      const posType = element.querySelector('.position-type');
      if (posType) posType.textContent = 'Available';
      element.classList.remove('partner', 'charity', 'technical');
      element.classList.add('available');
      element.onclick = null;
    } else {
      // –ó–∞–Ω—è—Ç–∞—è –ø–æ–∑–∏—Ü–∏—è
      const id = nodeData.userID !== '' ? `GW${nodeData.userID}` : app.formatAddress(userAddress);
      element.querySelector('.position-id').textContent = id;
      
      const levelSpan = element.querySelector('.position-level');
      if (levelSpan) {
        levelSpan.textContent = `Level ${nodeData.maxLevel}`;
      }

      // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Ç–∏–ø –ø–æ–∑–∏—Ü–∏–∏
      const positionType = await this.getPositionType(userAddress);
      element.classList.remove('available', 'partner', 'charity', 'technical');
      element.classList.add(positionType);

      // –ö–ª–∏–∫ - –æ—Ç–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª–∫—É –∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å –µ–≥–æ –º–∞—Ç—Ä–∏—Ü—É
      element.onclick = () => this.showPositionModal(userAddress);
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –¢–ê–ë–õ–ò–¶–ê –ü–ê–†–¢–ù–ï–†–û–í (–ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async loadMatrixTable() {
    try {
      const { currentRoot, currentDepth } = this.state;
      const tableBody = document.getElementById('matrixTableBody');
      
      if (!tableBody) return;

      // üî• –ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–ï: –î–ª—è –±–æ–ª—å—à–∏—Ö –≥–ª—É–±–∏–Ω
      if (currentDepth > 8) {
        const confirmed = confirm(
          `–ì–ª—É–±–∏–Ω–∞ ${currentDepth} —Å–æ–¥–µ—Ä–∂–∏—Ç ${Math.pow(2, currentDepth)} –ø–æ–∑–∏—Ü–∏–π.\n` +
          `–≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –∏ –≤—ã–∑–æ–≤–æ–≤ –∫ –∫–æ–Ω—Ç—Ä–∞–∫—Ç—É.\n\n` +
          `–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å –∑–∞–≥—Ä—É–∑–∫—É?`
        );
        if (!confirmed) {
          tableBody.innerHTML = '<tr><td colspan="7" class="no-data">–ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞</td></tr>';
          return;
        }
      }

      tableBody.innerHTML = '<tr><td colspan="7" class="no-data">–ó–∞–≥—Ä—É–∑–∫–∞...</td></tr>';

      // üî• –ò–°–ü–†–ê–í–õ–ï–ù–û: –°–Ω–∞—á–∞–ª–∞ –ø–æ–ª—É—á–∞–µ–º –ü–û–ó–ò–¶–ò–Æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∞—Ç—Ä–∏—Ü–µ
      const rootPos = await this.contracts.globalWay.getUserMatrixPosition(currentRoot);
      
      if (rootPos.eq(0)) {
        tableBody.innerHTML = '<tr><td colspan="7" class="no-data">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –≤ –º–∞—Ç—Ä–∏—Ü–µ</td></tr>';
        return;
      }

      // üî• –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –õ–û–ì–ò–ö–ê: –ü–æ–ª—É—á–∞–µ–º –¢–û–õ–¨–ö–û –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –Ω–∞ –≥–ª—É–±–∏–Ω–µ currentDepth
      const positions = await this.getPositionsAtDepth(rootPos, currentDepth);

      // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–º –∫–æ–ª–∏—á–µ—Å—Ç–≤–µ –ø–æ–∑–∏—Ü–∏–π
      const maxPositions = Math.pow(2, currentDepth);
      document.getElementById('currentMatrixLevel').textContent = currentDepth;

      // –°–æ–±–∏—Ä–∞–µ–º –¥–µ—Ç–∞–ª–∏ –¥–ª—è –∫–∞–∂–¥–æ–π –ø–æ–∑–∏—Ü–∏–∏
      const details = [];
      
      // üî• –û–ü–¢–ò–ú–ò–ó–ê–¶–ò–Ø: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å –¥–ª—è –±–æ–ª—å—à–∏—Ö –≥–ª—É–±–∏–Ω
      const showProgress = positions.length > 50;
      
      for (let i = 0; i < positions.length; i++) {
        if (showProgress && i % 10 === 0) {
          tableBody.innerHTML = `<tr><td colspan="7" class="no-data">–ó–∞–≥—Ä—É–∑–∫–∞... ${i}/${positions.length}</td></tr>`;
        }
        
        const position = positions[i];
        
        // –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞
        const [userAddress] = await this.contracts.globalWay.getMatrixPosition(position);
        
        // üî• –ü–†–ê–í–ò–õ–¨–ù–ê–Ø –ü–†–û–í–ï–†–ö–ê: –ü—É—Å—Ç–æ–π –∞–¥—Ä–µ—Å
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤—Å–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã –ø—É—Å—Ç–æ–≥–æ –∞–¥—Ä–µ—Å–∞
        const isEmptyAddress = 
          !userAddress || 
          userAddress === ethers.constants.AddressZero ||
          userAddress === '0x0000000000000000000000000000000000000000' ||
          userAddress.toLowerCase() === '0x0000000000000000000000000000000000000000';
        
        if (!isEmptyAddress) {
          // ‚úÖ –ü–æ–∑–∏—Ü–∏—è –∑–∞–Ω—è—Ç–∞ - –ø–æ–ª—É—á–∞–µ–º –¥–µ—Ç–∞–ª–∏
          const posDetails = await this.getPositionDetails(userAddress);
          posDetails.number = details.length + 1; // –ù–æ–º–µ—Ä –ø–æ –ø–æ—Ä—è–¥–∫—É —Å—Ä–µ–¥–∏ –ó–ê–ù–Ø–¢–´–•
          posDetails.position = position.toString();
          posDetails.relativePosition = i + 1; // –ü–æ–∑–∏—Ü–∏—è –≤ –¥–µ—Ä–µ–≤–µ
          details.push(posDetails);
        }
      }

      if (details.length === 0) {
        tableBody.innerHTML = '<tr><td colspan="7" class="no-data">–ù–µ—Ç –ø–∞—Ä—Ç–Ω–µ—Ä–æ–≤ –Ω–∞ —ç—Ç–æ–º —É—Ä–æ–≤–Ω–µ (0/' + maxPositions + ')</td></tr>';
        return;
      }

      // üî• –ù–û–í–û–ï: –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–∫–æ–ª—å–∫–æ –ø–æ–∑–∏—Ü–∏–π –∑–∞–Ω—è—Ç–æ
      console.log(`‚úÖ Found ${details.length} occupied positions out of ${maxPositions}`);
      
      // –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –∑–∞–Ω—è—Ç—ã—Ö –ø–æ–∑–∏—Ü–∏—è—Ö
      document.getElementById('maxPositionsInfo').textContent = `${details.length}/${maxPositions}`;

      // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É - –¢–û–õ–¨–ö–û –ó–ê–ù–Ø–¢–´–ï –ü–û–ó–ò–¶–ò–ò
      tableBody.innerHTML = details.map((pos, index) => `
        <tr>
          <td>${index + 1}</td>
          <td>${pos.id}</td>
          <td>${app.formatAddress(pos.address)}</td>
          <td>${pos.sponsorId}</td>
          <td>${pos.date}</td>
          <td>${pos.level}</td>
          <td><span class="badge badge-${pos.rank.toLowerCase()}">${pos.rank}</span></td>
        </tr>
      `).join('');

      this.state.matrixData = details;

    } catch (error) {
      console.error('Error loading matrix table:', error);
      const tableBody = document.getElementById('matrixTableBody');
      if (tableBody) {
        tableBody.innerHTML = '<tr><td colspan="7" class="no-data">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>';
      }
    }
  },

  // üî• –ö–õ–Æ–ß–ï–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –ü–æ–ª—É—á–∏—Ç—å –ø–æ–∑–∏—Ü–∏–∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –≥–ª—É–±–∏–Ω–µ
  getPositionsAtDepth(rootPos, depth) {
    console.log(`üìä Getting positions at depth ${depth} from root position:`, rootPos.toString());
    
    // –î–ª—è –≥–ª—É–±–∏–Ω—ã N –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å 2^N –ø–æ–∑–∏—Ü–∏–π
    const count = Math.pow(2, depth);
    const positions = [];
    
    // –ù–∞—á–∞–ª—å–Ω—ã–π –∏–Ω–¥–µ–∫—Å –≤ –ø–æ–ª–Ω–æ–º –±–∏–Ω–∞—Ä–Ω–æ–º –¥–µ—Ä–µ–≤–µ –¥–ª—è –≥–ª—É–±–∏–Ω—ã depth
    // –ì–ª—É–±–∏–Ω–∞ 1: –∏–Ω–¥–µ–∫—Å—ã 1-2 (–æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –∫–æ—Ä–Ω—è 0)
    // –ì–ª—É–±–∏–Ω–∞ 2: –∏–Ω–¥–µ–∫—Å—ã 3-6
    // –ì–ª—É–±–∏–Ω–∞ 3: –∏–Ω–¥–µ–∫—Å—ã 7-14
    const startIndex = Math.pow(2, depth) - 1;
    
    // üî• –ò–°–ü–û–õ–¨–ó–£–ï–ú BigNumber –¥–ª—è –≤—Å–µ—Ö –≤—ã—á–∏—Å–ª–µ–Ω–∏–π
    const rootPosBN = ethers.BigNumber.from(rootPos);
    
    for (let i = 0; i < count; i++) {
      const relativeIndex = startIndex + i;
      const absolutePos = this.calculateChildPosition(rootPosBN, relativeIndex);
      positions.push(absolutePos);
    }
    
    console.log(`‚úÖ Calculated ${positions.length} positions for depth ${depth}`);
    if (positions.length <= 10) {
      console.log('Positions:', positions.map(p => p.toString()));
    }
    
    return positions;
  },

  // üî• –ú–ê–¢–ï–ú–ê–¢–ò–ö–ê: –í—ã—á–∏—Å–ª–∏—Ç—å –∞–±—Å–æ–ª—é—Ç–Ω—É—é –ø–æ–∑–∏—Ü–∏—é —Ä–µ–±–µ–Ω–∫–∞ (—Å BigNumber)
  calculateChildPosition(rootPosBN, relativeIndex) {
    if (relativeIndex === 0) return rootPosBN;
    
    // –†–µ–∫—É—Ä—Å–∏–≤–Ω–æ –Ω–∞—Ö–æ–¥–∏–º —Ä–æ–¥–∏—Ç–µ–ª—è
    const parentRelative = Math.floor((relativeIndex - 1) / 2);
    const parentPosBN = this.calculateChildPosition(rootPosBN, parentRelative);
    
    // –õ–µ–≤—ã–π –∏–ª–∏ –ø—Ä–∞–≤—ã–π —Ä–µ–±–µ–Ω–æ–∫?
    const isLeftChild = (relativeIndex % 2) === 1;
    
    // üî• –ò—Å–ø–æ–ª—å–∑—É–µ–º BigNumber –¥–ª—è —É–º–Ω–æ–∂–µ–Ω–∏—è –∏ —Å–ª–æ–∂–µ–Ω–∏—è
    return parentPosBN.mul(2).add(isLeftChild ? 1 : 2);
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –°–¢–ê–¢–ò–°–¢–ò–ö–ê (–ò–ó GlobalWayStats –ö–û–ù–¢–†–ê–ö–¢–ê)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async loadMatrixStats() {
    try {
      const userAddress = app.state.userAddress;

      // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª–Ω—É—é —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∏–∑ –∫–æ–Ω—Ç—Ä–∞–∫—Ç–∞ GlobalWayStats
      const fullStats = await this.contracts.stats.getUserFullStats(userAddress);
      
      // fullStats –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
      // [0] isRegistered
      // [1] sponsor
      // [2] maxLevel
      // [3] quarterlyActive
      // [4] marketingReferralBalance
      // [5] marketingMatrixBalance
      // [6] quarterlyBalance
      // [7] investmentBalance
      // [8] leaderBalance
      // [9] totalPendingBalance
      // [10] totalInvested
      // [11] totalInvestmentReceived
      // [12] investmentROI

      // –ü–æ–ª—É—á–∞–µ–º —Å—Ç—Ä—É–∫—Ç—É—Ä—É –∫–æ–º–∞–Ω–¥—ã
      const structureStats = await this.contracts.stats.getUserStructureStats(userAddress);
      // [0] directReferrals
      // [1] referrals[]
      // [2] activeLevels
      // [3] levelStatus[]

      // üî• TODO: –î–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–æ–¥—Å—á–µ—Ç —Ç–∏–ø–æ–≤ –ø–æ–∑–∏—Ü–∏–π
      // –ü–æ–∫–∞ —É–ø—Ä–æ—â–µ–Ω–Ω–∞—è –≤–µ—Ä—Å–∏—è
      this.state.stats = {
        totalActive: Number(structureStats[0]), // directReferrals
        fromPartners: Number(structureStats[0]),
        fromCharity: 0,  // TODO: –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –∏–∑ quarterly
        fromTechnical: 0 // TODO: –ø–æ–¥—Å—á–∏—Ç–∞—Ç—å –∏–∑ techAccounts
      };

      this.updateStatsUI();

    } catch (error) {
      console.error('Error loading matrix stats:', error);
      // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –Ω—É–ª–µ–≤—ã–µ –∑–Ω–∞—á–µ–Ω–∏—è –ø—Ä–∏ –æ—à–∏–±–∫–µ
      this.state.stats = {
        totalActive: 0,
        fromPartners: 0,
        fromCharity: 0,
        fromTechnical: 0
      };
      this.updateStatsUI();
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –î–ï–¢–ê–õ–ò –ü–û–ó–ò–¶–ò–ò
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async getPositionDetails(address) {
    try {
      // ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      const userID = await this.contracts.helper.getUserID(address);
      const id = userID !== '' ? `GW${userID}` : app.formatAddress(address);

      // –°–ø–æ–Ω—Å–æ—Ä
      const sponsor = await this.contracts.globalWay.getUserSponsor(address);
      const sponsorID = await this.contracts.helper.getUserID(sponsor);
      const sponsorId = sponsorID !== '' ? `GW${sponsorID}` : app.formatAddress(sponsor);

      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
      const maxLevel = Number(await this.contracts.globalWay.getUserMaxLevel(address));

      // –†–∞–Ω–≥
      const [rankQualified] = await this.contracts.helper.getUserQualificationStatus(address);
      const rank = this.getRankName(rankQualified);

      // –î–∞—Ç–∞ –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
      const date = await this.getActivationDate(address);

      return {
        address,
        id,
        sponsorId,
        level: maxLevel,
        rank,
        date
      };
    } catch (error) {
      console.error('Error getting position details:', error);
      return {
        address,
        id: app.formatAddress(address),
        sponsorId: '-',
        level: 0,
        rank: '–ù–∏–∫—Ç–æ',
        date: '-'
      };
    }
  },

  // –ü–æ–ª—É—á–∏—Ç—å –¥–∞—Ç—É –∞–∫—Ç–∏–≤–∞—Ü–∏–∏
  async getActivationDate(address) {
    try {
      const filter = this.contracts.globalWay.filters.LevelActivated(address, 1);
      const events = await this.contracts.globalWay.queryFilter(filter, -100000);
      
      if (events.length > 0) {
        const block = await events[0].getBlock();
        return new Date(block.timestamp * 1000).toLocaleDateString();
      }
      return '-';
    } catch (error) {
      return '-';
    }
  },

  // –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å —Ç–∏–ø –ø–æ–∑–∏—Ü–∏–∏ (partner/charity/technical)
  async getPositionType(address) {
    try {
      // –ü—Ä–æ–≤–µ—Ä—è–µ–º quarterly info
      const quarterlyInfo = await this.contracts.quarterly.getUserQuarterlyInfo(address);
      const charityAccount = quarterlyInfo[4]; // charityAccount –∏–∑ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã
      
      if (charityAccount !== ethers.ZeroAddress) {
        return 'charity';
      }

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º tech accounts
      const techAccount1 = quarterlyInfo[5];
      const techAccount2 = quarterlyInfo[6];
      
      if (techAccount1 !== ethers.ZeroAddress || techAccount2 !== ethers.ZeroAddress) {
        return 'technical';
      }

      return 'partner';
    } catch (error) {
      return 'partner';
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –ü–û–ò–°–ö –í –ú–ê–¢–†–ò–¶–ï
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async searchMatrix() {
    const searchInput = document.getElementById('matrixSearchInput');
    if (!searchInput) return;

    const searchValue = searchInput.value.trim();
    if (!searchValue) {
      app.showNotification('–í–≤–µ–¥–∏—Ç–µ ID –¥–ª—è –ø–æ–∏—Å–∫–∞', 'error');
      return;
    }

    try {
      // –£–±–∏—Ä–∞–µ–º –ø—Ä–µ—Ñ–∏–∫—Å GW
      const searchID = searchValue.replace(/^GW/i, '');

      app.showNotification('–ü–æ–∏—Å–∫...', 'info');
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log(`üîç –ü–û–ò–°–ö ID: GW${searchID}`);

      // üî• –®–ê–ì 1: –ü–æ–ª—É—á–∞–µ–º –∞–¥—Ä–µ—Å –ø–æ ID
      const searchAddress = await this.contracts.helper.getAddressByID(searchID);
      console.log(`üìç –ê–¥—Ä–µ—Å –Ω–∞–π–¥–µ–Ω:`, searchAddress);

      if (searchAddress === ethers.constants.AddressZero || 
          searchAddress === '0x0000000000000000000000000000000000000000') {
        app.showNotification('ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ', 'error');
        console.log('‚ùå ID –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç');
        return;
      }

      // üî• –®–ê–ì 2: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é
      const isRegistered = await this.contracts.globalWay.isUserRegistered(searchAddress);
      console.log(`‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:`, isRegistered);

      if (!isRegistered) {
        app.showNotification(`GW${searchID} –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω`, 'error');
        console.log('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω –≤ GlobalWay');
        return;
      }

      // üî• –®–ê–ì 3: –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ü–∏—é –≤ –º–∞—Ç—Ä–∏—Ü–µ
      const matrixPosition = await this.contracts.globalWay.getUserMatrixPosition(searchAddress);
      console.log(`üìä –ü–æ–∑–∏—Ü–∏—è –≤ –º–∞—Ç—Ä–∏—Ü–µ:`, matrixPosition.toString());

      if (matrixPosition.eq(0)) {
        app.showNotification(
          `GW${searchID} –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –ù–ï–¢ –≤ –º–∞—Ç—Ä–∏—Ü–µ!\n` +
          `(Matrix position = 0)`, 
          'warning'
        );
        console.log('‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç –ø–æ–∑–∏—Ü–∏–∏ –≤ –º–∞—Ç—Ä–∏—Ü–µ!');
        console.log('–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç —á—Ç–æ –æ–Ω –≤ —Å–∏—Å—Ç–µ–º–µ, –Ω–æ –º–µ—Å—Ç–æ –≤ –±–∏–Ω–∞—Ä–Ω–æ–π –º–∞—Ç—Ä–∏—Ü–µ –Ω–µ –Ω–∞–∑–Ω–∞—á–µ–Ω–æ');
        return;
      }

      // üî• –®–ê–ì 4: –ü–æ–ª—É—á–∞–µ–º —Å–ø–æ–Ω—Å–æ—Ä–∞
      const sponsor = await this.contracts.globalWay.getUserSponsor(searchAddress);
      const sponsorID = await this.contracts.helper.getUserID(sponsor);
      console.log(`üë§ –°–ø–æ–Ω—Å–æ—Ä: GW${sponsorID} (${sponsor})`);

      // üî• –®–ê–ì 5: –ò—â–µ–º –≤ –º–∞—Ç—Ä–∏—Ü–µ –æ—Ç –∫–æ—Ä–Ω—è
      const [found, position, depth] = await this.contracts.helper.searchInMatrix(
        app.state.userAddress,  // –æ—Ç —á—å–µ–π –º–∞—Ç—Ä–∏—Ü—ã –∏—â–µ–º
        searchAddress,          // –∫–æ–≥–æ –∏—â–µ–º
        12                      // –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –≥–ª—É–±–∏–Ω–∞ –ø–æ–∏—Å–∫–∞ (—É–≤–µ–ª–∏—á–∏–ª –¥–æ 12)
      );

      console.log(`üîç –ü–æ–∏—Å–∫ –≤ –º–∞—Ç—Ä–∏—Ü–µ:`, { found, position: position?.toString(), depth });

      if (found) {
        app.showNotification(
          `‚úÖ –ù–∞–π–¥–µ–Ω–æ! GW${searchID}\n` +
          `–ü–æ–∑–∏—Ü–∏—è: ${position}\n` +
          `–ì–ª—É–±–∏–Ω–∞: ${depth}`, 
          'success'
        );
        console.log('‚úÖ –ù–ê–ô–î–ï–ù –í –í–ê–®–ï–ô –ú–ê–¢–†–ò–¶–ï');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
        
        // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –Ω–∞ –Ω–∞–π–¥–µ–Ω–Ω–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        this.state.currentRoot = searchAddress;
        await this.loadMatrixVisualization();
      } else {
        app.showNotification(
          `‚ö†Ô∏è GW${searchID} –ù–ï –Ω–∞–π–¥–µ–Ω –≤ –≤–∞—à–µ–π –º–∞—Ç—Ä–∏—Ü–µ\n` +
          `(–û–Ω –≤ –ø–æ–∑–∏—Ü–∏–∏ ${matrixPosition}, –Ω–æ –≤ –¥—Ä—É–≥–æ–π –≤–µ—Ç–∫–µ)\n` +
          `–°–ø–æ–Ω—Å–æ—Ä: GW${sponsorID}`, 
          'warning'
        );
        console.log('‚ö†Ô∏è –ù–ï –ù–ê–ô–î–ï–ù –≤ –≤–∞—à–µ–π –º–∞—Ç—Ä–∏—Ü–µ (–≥–ª—É–±–∏–Ω–∞ –ø–æ–∏—Å–∫–∞: 12 —É—Ä–æ–≤–Ω–µ–π)');
        console.log('–í–æ–∑–º–æ–∂–Ω–æ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≥–ª—É–±–∂–µ –∏–ª–∏ –≤ –¥—Ä—É–≥–æ–π –≤–µ—Ç–∫–µ –º–∞—Ç—Ä–∏—Ü—ã');
        console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      }

    } catch (error) {
      console.error('‚ùå –û–®–ò–ë–ö–ê –ü–û–ò–°–ö–ê:', error);
      app.showNotification('–û—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞', 'error');
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –ú–û–î–ê–õ–¨–ù–û–ï –û–ö–ù–û –ü–û–ó–ò–¶–ò–ò
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  async showPositionModal(address) {
    try {
      const details = await this.getPositionDetails(address);

      // –ó–∞–ø–æ–ª–Ω—è–µ–º –º–æ–¥–∞–ª–∫—É
      document.getElementById('modalPositionId').textContent = details.id;
      document.getElementById('modalSponsorId').textContent = details.sponsorId;
      document.getElementById('modalAddress').textContent = app.formatAddress(details.address);
      document.getElementById('modalLevel').textContent = details.level;
      document.getElementById('modalQualification').textContent = details.rank;

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º quarterly —Å—Ç–∞—Ç—É—Å
      const quarterlyStats = await this.contracts.stats.getUserQuarterlyStats(address);
      const status = quarterlyStats[3] ? '–ê–∫—Ç–∏–≤–µ–Ω' : '–ù–µ–∞–∫—Ç–∏–≤–µ–Ω'; // isActive
      document.getElementById('modalStatus').textContent = status;

      // –ö–Ω–æ–ø–∫–∞ "–ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –º–∞—Ç—Ä–∏—Ü—É" - –º–µ–Ω—è–µ—Ç –∫–æ—Ä–µ–Ω—å –Ω–∞ —ç—Ç–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
      document.getElementById('viewMatrixBtn').onclick = () => {
        this.state.currentRoot = address;
        this.loadMatrixVisualization();
        app.closeModal('positionModal');
      };

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª–∫—É
      app.showModal('positionModal');

    } catch (error) {
      console.error('Error showing modal:', error);
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // UI –≠–õ–ï–ú–ï–ù–¢–´
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

  // –°–æ–∑–¥–∞–Ω–∏–µ 12 –∫–Ω–æ–ø–æ–∫ –≥–ª—É–±–∏–Ω—ã
  createDepthButtons() {
    const container = document.getElementById('matrixLevels');
    if (!container) return;

    container.innerHTML = '';

    // 12 –∫–Ω–æ–ø–æ–∫ –¥–ª—è –≥–ª—É–±–∏–Ω—ã 1-12
    for (let depth = 1; depth <= 12; depth++) {
      const btn = document.createElement('button');
      btn.className = `level-btn ${depth === 1 ? 'active' : ''}`;
      btn.textContent = depth;
      
      // –ü–æ–¥—Å–∫–∞–∑–∫–∞ —Å –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ–º –ø–æ–∑–∏—Ü–∏–π
      const posCount = Math.pow(2, depth);
      btn.title = `–ì–ª—É–±–∏–Ω–∞ ${depth}: ${posCount} –ø–æ–∑–∏—Ü–∏–π`;
      
      btn.onclick = () => this.selectDepth(depth);
      container.appendChild(btn);
    }
  },

  // –í—ã–±–æ—Ä –≥–ª—É–±–∏–Ω—ã
  async selectDepth(depth) {
    // –û–±–Ω–æ–≤–ª—è–µ–º –∞–∫—Ç–∏–≤–Ω—É—é –∫–Ω–æ–ø–∫—É
    document.querySelectorAll('#matrixLevels .level-btn').forEach((btn, index) => {
      btn.classList.toggle('active', index + 1 === depth);
    });

    this.state.currentDepth = depth;
    this.state.currentRoot = app.state.userAddress; // –°–±—Ä–æ—Å –Ω–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

    // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¥–ª—è —ç—Ç–æ–π –≥–ª—É–±–∏–Ω—ã
    await this.loadMatrixTable();
  },

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ UI
  updateStatsUI() {
    const { totalActive, fromPartners, fromCharity, fromTechnical } = this.state.stats;

    const totalEl = document.getElementById('totalActivePositions');
    const partnerEl = document.getElementById('partnerPositions');
    const charityEl = document.getElementById('charityPositions');
    const techEl = document.getElementById('technicalPositions');

    if (totalEl) totalEl.textContent = totalActive;
    if (partnerEl) partnerEl.textContent = fromPartners;
    if (charityEl) charityEl.textContent = fromCharity;
    if (techEl) techEl.textContent = fromTechnical;
  },

  // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI
  initUI() {
    // –ö–Ω–æ–ø–∫–∞ –ø–æ–∏—Å–∫–∞
    const searchBtn = document.getElementById('matrixSearchBtn');
    if (searchBtn) {
      searchBtn.onclick = () => this.searchMatrix();
    }

    // Enter –≤ –ø–æ–∏—Å–∫–µ
    const searchInput = document.getElementById('matrixSearchInput');
    if (searchInput) {
      searchInput.onkeypress = (e) => {
        if (e.key === 'Enter') {
          this.searchMatrix();
        }
      };
    }

    // –ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–∫–∏
    const closeBtn = document.getElementById('closeModalBtn');
    if (closeBtn) {
      closeBtn.onclick = () => app.closeModal('positionModal');
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê (–¥–ª—è –æ—Ç–ª–∞–¥–∫–∏)
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  
  // üî• –ù–û–í–ê–Ø –§–£–ù–ö–¶–ò–Ø: –î–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ ID
  async diagnoseUser(userID) {
    try {
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      console.log(`üîç –î–ò–ê–ì–ù–û–°–¢–ò–ö–ê: GW${userID}`);
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      
      // –ê–¥—Ä–µ—Å
      const address = await this.contracts.helper.getAddressByID(userID);
      console.log(`üìç –ê–¥—Ä–µ—Å:`, address);
      
      if (address === ethers.constants.AddressZero) {
        console.log('‚ùå ID –Ω–µ –Ω–∞–π–¥–µ–Ω');
        return;
      }
      
      // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
      const isRegistered = await this.contracts.globalWay.isUserRegistered(address);
      console.log(`‚úÖ –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω:`, isRegistered);
      
      if (!isRegistered) {
        console.log('‚ùå –ù–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω');
        return;
      }
      
      // –ü–æ–∑–∏—Ü–∏—è –≤ –º–∞—Ç—Ä–∏—Ü–µ
      const matrixPos = await this.contracts.globalWay.getUserMatrixPosition(address);
      console.log(`üìä –ü–æ–∑–∏—Ü–∏—è –≤ –º–∞—Ç—Ä–∏—Ü–µ:`, matrixPos.toString());
      
      // –°–ø–æ–Ω—Å–æ—Ä
      const sponsor = await this.contracts.globalWay.getUserSponsor(address);
      const sponsorID = await this.contracts.helper.getUserID(sponsor);
      console.log(`üë§ –°–ø–æ–Ω—Å–æ—Ä: GW${sponsorID} (${sponsor})`);
      
      // –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å
      const maxLevel = await this.contracts.globalWay.getUserMaxLevel(address);
      console.log(`üìà –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π —É—Ä–æ–≤–µ–Ω—å:`, maxLevel);
      
      // –†–µ—Ñ–µ—Ä–∞–ª—ã
      const referrals = await this.contracts.globalWay.getUserReferrals(address);
      console.log(`üë• –†–µ—Ñ–µ—Ä–∞–ª–æ–≤:`, referrals.length);
      if (referrals.length > 0) {
        for (let i = 0; i < referrals.length; i++) {
          const refID = await this.contracts.helper.getUserID(referrals[i]);
          console.log(`  ${i+1}. GW${refID} (${referrals[i]})`);
        }
      }
      
      // –ü–æ–∏—Å–∫ –≤ –º–∞—Ç—Ä–∏—Ü–µ
      const yourPos = await this.contracts.globalWay.getUserMatrixPosition(app.state.userAddress);
      console.log(`\nüîç –ü–æ–∏—Å–∫ –æ—Ç –≤–∞—à–µ–π –ø–æ–∑–∏—Ü–∏–∏ (${yourPos.toString()}):`);
      
      const [found, foundPos, depth] = await this.contracts.helper.searchInMatrix(
        app.state.userAddress,
        address,
        12
      );
      
      if (found) {
        console.log(`‚úÖ –ù–ê–ô–î–ï–ù! –ü–æ–∑–∏—Ü–∏—è: ${foundPos}, –ì–ª—É–±–∏–Ω–∞: ${depth}`);
      } else {
        console.log(`‚ö†Ô∏è –ù–ï –ù–ê–ô–î–ï–ù –≤ –≤–∞—à–µ–π –≤–µ—Ç–∫–µ (–ø–æ–∏—Å–∫ –¥–æ –≥–ª—É–±–∏–Ω—ã 12)`);
      }
      
      console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
      
    } catch (error) {
      console.error('‚ùå –û—à–∏–±–∫–∞ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏:', error);
    }
  },

  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  // –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
  // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
  getRankName(rankQualified) {
    // rankQualified - —ç—Ç–æ –º–∞—Å—Å–∏–≤ [bronze, silver, gold, platinum]
    if (rankQualified[3]) return '–ü–ª–∞—Ç–∏–Ω–∞';
    if (rankQualified[2]) return '–ó–æ–ª–æ—Ç–æ';
    if (rankQualified[1]) return '–°–µ—Ä–µ–±—Ä–æ';
    if (rankQualified[0]) return '–ë—Ä–æ–Ω–∑–∞';
    return '–ù–∏–∫—Ç–æ';
  },

  // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö
  async refresh() {
    await this.loadAllData();
  }
};

// –≠–∫—Å–ø–æ—Ä—Ç –≤ window
window.matrixModule = matrixModule;
